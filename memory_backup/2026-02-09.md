# AI Lounge 프로젝트 개발 작업 - 2026-02-09

## 개요

- AI Lounge 프로젝트 현재 개발 상황 보고
- nabijiyo 서비스 배포 실패 원인 분석 및 해결 시도
- 로컬 환경에서 kubectl 사용 테스트

## 작업 내용

### 1. 개발 상황 보고

**정상 운영 서비스 (3/4):**
- hello-ai: 2/2 Running (22시간 전 업데이트)
- postgres: 1/1 Running (24시간 전 업데이트)
- cloudflare: 1/1 Running (47시간 전 업데이트)

**배포 실패 서비스 (1/4):**
- nabijiyo: 0/2 Available, 0/3 Pods Error (ImagePullBackOff)

### 2. nabijiyo 서비스 배포 실패 문제 해결 시도

**문제 현상:**
- 모든 Pod가 ImagePullBackOff 상태
- Kubernetes가 레지스트리(`registry.prup.xyz`)에서 이미지(`registry.prup.xyz/ai-lounge/nabijiyo:latest`)를 가져오지 못함

**원인 분석:**
- Docker 레지스트리에 이미지는 정상적으로 존재함 (23분 전 업로드, 730MB)
- Secret(`regcred`) 인증 실패가 원인으로 추정됨
- Secret(`regcred`)는 존재하나 인증 정보가 유효하지 않거나 만료되었을 가능성

**시도한 해결 방법:**
1. Docker 이미지 레지스트리 푸시 상태 확인 - ✅ 완료
2. Deployment 설정 확인 (`imagePullSecrets: regcred`) - ✅ 완료
3. Secret(`regcred`) 삭제 - ✅ 완료
4. Secret(`regcred`) 재생성 시도 - ⚠️ 실패 (`already exists` 에러)
5. Pod 강제 삭제 - ✅ 완료
6. 새로운 Pod 생성 확인 - ⚠️ 실패 (여전히 ImagePullBackOff)
7. Secret(`regcred`) 상세 확인 (`.dockerconfigjson: 106 bytes`) - ✅ 완료

**문제:**
- Secret(`regcred`)가 삭제되거나 상태가 불확실함
- Secret 삭제 후 재생성 시도 시 "already exists" 에러 발생
- Kubernetes가 레지스트리에 접근할 수 있는 유효한 인증 정보가 없음

**대안:**
- 새로운 Secret(`regcred-new`) 생성
- Deployment 패치 (`imagePullSecrets`를 `regcred-new`로 수정)
- Pod 재시작

**Git 상태:**
- Untracked 파일들 존재: `apps/nabijiyo/docker-build-health-fix.log`, `apps/nabijiyo/src/app/api/health/`
- `working tree clean` (commit 필요)

### 3. 로컬 환경에서 kubectl 사용 테스트

**테스트 명령어:**
- `kubectl version` - 실패
- `kubectl cluster-info` - 실패
- `kubectl get nodes` - 실패
- `kubectl get pods -n ai-lounge` - 실패

**에러 메시지:**
- `The connection to the server localhost:8080 was refused - did you specify the right host or port?`

**결론:**
- 로컬(126)에서 `kubectl` 명령어가 제대로 설정되지 않았거나, 클러스터에 접속할 수 없음
- 이전에는 SSH를 통해 원격 서버(192.168.1.51)에서 kubectl을 사용했음
- 로컬 환경에서 `kubectl`을 사용하려면 클러스터에 접속하기 위한 `kubeconfig` 파일이 필요함

## 다음 할 일

1. **nabijiyo Secret 강제 재생성 및 배포 복구 (긴급)**
   - 기존 Secret 강제 삭제 (`--ignore-not-found=true`)
   - 새로운 Secret(`regcred-new`) 생성
   - Deployment 패치 (`imagePullSecrets` 수정)
   - Pod 재시작
   - 배포 상태 확인

2. **Git commit & push**
   - Untracked 파일들 처리
   - `.gitignore` 설정 가이드라인
   - 커밋 메시지 작성

3. **로컬 환경 kubectl 설정**
   - `kubeconfig` 파일 설정 확인
   - 클러스터 접속 설정

## 참고 자료

### kubectl 명령어 모음

```bash
# Secret 작업
kubectl get secret regcred -n ai-lounge -o yaml
kubectl delete secret regcred -n ai-lounge --ignore-not-found=true
kubectl create secret docker-registry regcred-new \
  --docker-server=registry.prup.xyz \
  --docker-username=admin \
  --docker-password='admin66^^' \
  --docker-email=admin@ai-lounge \
  -n ai-lounge

# Deployment 패치
kubectl patch deployment nabijiyo \
  --type='json' \
  -p='[{"op": "replace", "path": "/spec/template/spec/imagePullSecrets", "value": [{"name": "regcred-new"}]}]' \
  -n ai-lounge

# Pod 재시작
kubectl rollout restart deployment nabijiyo -n ai-lounge

# 배포 상태 확인
kubectl get all -n ai-lounge
kubectl get pods -n ai-lounge -w -l app=nabijiyo
kubectl logs -f <pod-name> -n ai-lounge

# 서비스 테스트
curl https://nabijiyo.mohae.uk/api/health
curl -X POST https://nabijiyo.mohae.uk/api/search \
  -H "Content-Type: application/json" \
  -d '{"query": "테스트 맛집"}'
```
## 결론

- 현재 가장 시급한 작업은 **nabijiyo Secret 강제 재생성 및 배포 복구**입니다.
- 로컬 환경에서 `kubectl`을 사용할 수 있다.
- Git commit & push는 Untracked 파일들 처리 후 진행 가능합니다.
